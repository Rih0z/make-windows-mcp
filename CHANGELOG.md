# Changelog

## [1.0.4] - 2025-07-04

### 修正
- **run_batchツールのパス制限修正**:
  - 環境変数`ALLOWED_BATCH_DIRS`で許可ディレクトリを管理
  - デフォルトで`C:\builds\AIServer\`を許可ディレクトリに追加
  - セミコロン区切りで複数ディレクトリを指定可能
  - エラーメッセージで許可されたディレクトリを表示

### 改善
- バッチファイルの検証ロジックを環境変数ベースに変更
- .cmdファイルもサポート対象に明示的に追加
- パス検証を大文字小文字を区別しないように改善
- 危険モードではrun_batchのパス制限を完全にバイパス（任意のバッチファイルを実行可能）

### ドキュメント
- README.mdにALLOWED_BATCH_DIRS環境変数を追加
- run_batchツールの説明を更新（許可ディレクトリのカスタマイズ方法を追加）
- CLAUDE.mdにrun_batchツール設定の詳細を追加
- .env.exampleに新しい環境変数を追加

## [1.0.3] - 2025-07-04

### 追加
- **run_batchツール**: C:\builds\配下のバッチファイルを安全に実行する新しいMCPツール
  - バッチファイルのパス検証（正規表現パターン）
  - 作業ディレクトリの指定サポート
  - 実行ログの記録
- **開発モードの機能拡張**:
  - バッチファイルの直接実行サポート（.bat, .cmdファイル）
  - PowerShellでのセミコロン（;）演算子サポート
  - `cmd`および`&`コマンドを許可コマンドリストに追加
  - Set-Location; コマンド形式のサポート
  - & 'path\to\script.bat' 形式のサポート

### 改善
- セキュリティバリデーターで`&`を危険パターンから除外（開発モードで必要）
- 通常の許可コマンドに`set-location`, `invoke-command`, `start-process`を追加

### ドキュメント
- run_batchツールの使用方法と例を追加
- 開発モードでのバッチファイル実行例を更新

## [1.0.2] - 2025-07-04

### 修正
- **package.jsonのパス修正**: サーバー起動時のバージョン表示でpackage.jsonが見つからない問題を修正
- **アップデートスクリプト改善**: 
  - package.jsonを正しくコピーするように修正
  - scriptsセクションを保持するように修正（バージョン情報が消えないように）
  - 開発モード環境変数を自動追加

## [1.0.1] - 2025-07-04

### 追加
- **開発コマンドモード**: 危険モードよりも安全に特定の開発用コマンドを実行可能
  - `tasklist`, `netstat`, `type`, `python`, `pip`などの開発ツールを許可
  - コマンド連結（`&&`, `||`, `|`）のサポート
  - バッチファイル実行のサポート（許可されたパス内のみ）
  - 実行パスの制限（`C:\builds\`, `C:\projects\`, `C:\dev\`）
- **バージョン表示**: サーバー起動時にバージョン番号を表示

### ドキュメント
- 開発コマンドモードの詳細な設定方法と使用例を追加
- 環境変数一覧に開発モード設定を追加

## [1.1.0] - 2025-07-03

### セキュリティ強化

#### 🔒 重大なセキュリティ修正
- **コマンドインジェクション対策**: `shell: true`を削除し、安全なコマンド実行方式に変更
- **タイムアウト処理**: すべてのコマンド実行とSSH接続にタイムアウトを実装
- **SSH認証情報の暗号化**: AES-256-GCM暗号化によるパスワード保護

#### 🛡️ セキュリティ機能の追加
- 環境変数の起動時検証
- 本番環境での必須設定チェック
- パスワード暗号化ユーティリティ (`server/setup/encrypt-password.js`)
- SSH接続ログの改善（パスワードのハッシュ化）

### 🐛 バグ修正
- `stdout`/`stderr`が未定義の場合のエラーハンドリング改善
- PowerShellコマンドの実行方式を修正
- テストのモック改善による安定性向上

### 📚 ドキュメント
- セキュリティベストプラクティスの更新
- 新機能の詳細な説明を追加
- パスワード暗号化の手順を追加

### 🔧 技術的改善
- `child_process.spawn`の安全な使用
- プロセスのタイムアウトとクリーンアップ
- エラーハンドリングの一貫性向上

### 📁 ビルド管理の改善
- 固定ビルドディレクトリ構造: `C:\build\<project-name>\`
- プロジェクトリポジトリ全体の保存
- リリース成果物の専用ディレクトリ: `C:\build\<project-name>\release\`
- xcopyによるプロジェクト構造の保持

## [1.0.0] - 初期リリース

### 機能
- Windows VM上でのMCPサーバー実装
- .NETアプリケーションのリモートビルド
- PowerShellコマンドの安全な実行
- NordVPNメッシュネットワーク対応
- SSH経由のリモート実行
- 包括的なセキュリティ機能
  - IPホワイトリスト
  - レート制限
  - Bearer認証
  - コマンド検証
  - パストラバーサル防止